<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Ben</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Welcome Header */
        .welcome-header {
            background: #2d2d2d;
            border-bottom: 2px solid #404040;
            padding: 2rem;
            text-align: center;
        }
        
        .welcome-content {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .avatar-container {
            margin-bottom: 1.5rem;
        }
        
        .avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid #5865F2;
            object-fit: cover;
            background: #404040;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
        }
        
        .welcome-title {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #ffffff;
        }
        
        .welcome-subtitle {
            font-size: 1rem;
            color: #a0a0a0;
            margin-bottom: 1rem;
        }
        
        .welcome-description {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #c0c0c0;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .welcome-description a {
            color: #5865F2;
            text-decoration: none;
            border-bottom: 1px solid #5865F2;
        }
        
        .welcome-description a:hover {
            color: #7289ff;
        }
        
        /* Chat Container */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: #1a1a1a;
        }
        
        .message {
            max-width: 70%;
            padding: 1rem;
            border-radius: 0.5rem;
            line-height: 1.5;
        }
        
        .user-message {
            align-self: flex-end;
            background: #5865F2;
            color: white;
        }
        
        .assistant-message {
            align-self: flex-start;
            background: #2d2d2d;
            border: 1px solid #404040;
        }
        
        .message-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .message-content p {
            margin-bottom: 0.75rem;
        }
        
        .message-content p:last-child {
            margin-bottom: 0;
        }
        
        .message-content a {
            color: #5865F2;
            text-decoration: none;
            border-bottom: 1px solid #5865F2;
            transition: all 0.2s ease;
        }
        
        .message-content a:hover {
            color: #7289ff;
            border-bottom: 2px solid #7289ff;
        }
        
        .sources {
            font-size: 0.75rem;
            margin-top: 0.75rem;
            padding: 0.5rem;
            background: rgba(88, 101, 242, 0.1);
            border-left: 3px solid #5865F2;
            border-radius: 0.25rem;
            color: #a8b3ff;
        }
        
        .sources-title {
            font-weight: 600;
            color: #5865F2;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }
        
        .sources a {
            color: #b8c3ff;
            text-decoration: none;
            border-bottom: 1px dotted #b8c3ff;
            transition: all 0.2s ease;
        }
        
        .sources a:hover {
            color: #5865F2 !important;
            border-bottom-style: solid;
        }
        
        .source-item {
            padding: 0.15rem 0;
            color: #b8c3ff;
        }
        
        .more-indicator {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            padding: 0.4rem 0.6rem;
            background: rgba(67, 181, 129, 0.15);
            border-left: 3px solid #43B581;
            border-radius: 0.25rem;
            color: #a8ffdb;
            font-weight: 500;
        }
        
        .loading {
            align-self: flex-start;
            padding: 1rem;
            color: #888;
        }
        
        /* Input Container */
        #input-container {
            padding: 1.5rem 2rem;
            background: #2d2d2d;
            border-top: 1px solid #404040;
            display: flex;
            gap: 1rem;
        }
        
        #message-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 0.5rem;
            color: #e0e0e0;
            font-size: 1rem;
            outline: none;
        }
        
        #message-input:focus {
            border-color: #5865F2;
        }
        
        #send-button {
            padding: 0.75rem 2rem;
            background: #5865F2;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        #send-button:hover:not(:disabled) {
            background: #4752c4;
        }
        
        #send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Scrollbar styling */
        #chat-container::-webkit-scrollbar {
            width: 8px;
        }
        
        #chat-container::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        #chat-container::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }
        
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #505050;
        }
    </style>
</head>
<body>
    <!-- Welcome Header -->
    <div class="welcome-header">
        <div class="welcome-content">
            <div class="avatar-container">
                <div class="avatar" id="avatar">
                    ðŸ§ 
                </div>
            </div>
            <h1 class="welcome-title">Chat with Ben</h1>
            <p class="welcome-subtitle">Personal Knowledge Assistant</p>
            <p class="welcome-description">
                Welcome! I'm Ben, and this AI assistant has access to all my research notes and articles from my Obsidian vault. 
                Ask me anything about AI, technology, business strategy, or any topics I've been exploring. 
                I'll reference my actual writings and research to give you informed answers based on my knowledge collection.
            </p>
        </div>
    </div>
    
    <!-- Chat Messages -->
    <div id="chat-container"></div>
    
    <!-- Input Area -->
    <div id="input-container">
        <input 
            type="text" 
            id="message-input" 
            placeholder="Ask Ben anything about his research and notes..."
            autocomplete="off"
        >
        <button id="send-button">Send</button>
    </div>

    <script>
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const conversationHistory = [];
        
        // Generate a simple session ID
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        function addMessage(content, isUser, sources = [], hasMoreResults = false, remainingCount = 0) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isUser) {
                contentDiv.textContent = content;
            } else {
                // Convert markdown links [text](url) to HTML <a> tags
                let htmlContent = content;
                
                // Replace markdown links with HTML
                htmlContent = htmlContent.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, function(match, text, url) {
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${text}</a>`;
                });
                
                // Split into paragraphs
                const paragraphs = htmlContent.split('\n\n');
                
                paragraphs.forEach(para => {
                    if (para.trim()) {
                        const p = document.createElement('p');
                        p.innerHTML = para.trim();
                        contentDiv.appendChild(p);
                    }
                });
                
                // Fallback if no paragraphs
                if (contentDiv.children.length === 0) {
                    contentDiv.innerHTML = htmlContent;
                }
            }
            
            messageDiv.appendChild(contentDiv);
            
            // Sources at bottom
            if (!isUser && sources.length > 0) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = 'sources';
                
                const sourcesTitle = document.createElement('div');
                sourcesTitle.className = 'sources-title';
                sourcesTitle.textContent = 'ðŸ”Ž Referenced sources:';
                sourcesDiv.appendChild(sourcesTitle);
                
                sources.forEach(source => {
                    const sourceItem = document.createElement('div');
                    sourceItem.className = 'source-item';
                    
                    if (source.url) {
                        const link = document.createElement('a');
                        link.href = source.url;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        link.textContent = `â€¢ ${source.name}`;
                        sourceItem.appendChild(link);
                    } else {
                        sourceItem.textContent = `â€¢ ${source.name}`;
                    }
                    
                    sourcesDiv.appendChild(sourceItem);
                });
                
                messageDiv.appendChild(sourcesDiv);
            }
            
            // "More results available" indicator
            if (!isUser && hasMoreResults) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'more-indicator';
                moreDiv.textContent = `ðŸ“š +${remainingCount} more article${remainingCount !== 1 ? 's' : ''} available`;
                messageDiv.appendChild(moreDiv);
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading';
            loadingDiv.id = 'loading-indicator';
            loadingDiv.textContent = 'Ben is thinking...';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('loading-indicator');
            if (loadingDiv) loadingDiv.remove();
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            messageInput.value = '';
            sendButton.disabled = true;
            showLoading();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message,
                        conversationHistory,
                        sessionId
                    })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                hideLoading();
                addMessage(
                    data.response, 
                    false, 
                    data.sourcesUsed || [],
                    data.hasMoreResults || false,
                    data.remainingCount || 0
                );
                
                conversationHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: data.response }
                );

            } catch (error) {
                hideLoading();
                addMessage('Error: ' + error.message, false);
            } finally {
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        messageInput.focus();
    </script>
</body>
</html>
